# Story 2.3: 10-Second Recording Timer

## Status
Approved

## Story
**As a** sales professional,  
**I want** recordings to automatically stop after 10 seconds,  
**so that** I don't have to remember to press the button again and recordings have consistent length.

## Acceptance Criteria
1. FreeRTOS timer starts when recording begins
2. Timer automatically triggers recording stop after exactly 10 seconds
3. Timer integrates with recording state machine transitions
4. Timer cancellation works if manual stop occurs before 10 seconds
5. LED feedback indicates timer countdown (optional visual cue)
6. Timer failure doesn't crash the device or leave it in recording state
7. Resulting WAV files match expected 10-second duration (320KB at 16kHz)

## Tasks / Subtasks
- [ ] Implement FreeRTOS timer for recording duration (AC: 1, 2)
  - [ ] Create 10-second one-shot timer
  - [ ] Implement timer callback function
  - [ ] Add timer creation and configuration
  - [ ] Test timer accuracy and reliability
- [ ] Integrate timer with state machine (AC: 3)
  - [ ] Start timer when entering RECORDING state
  - [ ] Timer callback triggers RECORDING → STOPPING transition
  - [ ] Ensure timer cleanup on state changes
- [ ] Implement timer cancellation (AC: 4)
  - [ ] Cancel timer on manual stop (if implemented)
  - [ ] Cancel timer on error conditions
  - [ ] Proper timer resource cleanup
- [ ] Add LED countdown feedback (AC: 5)
  - [ ] Optional: LED blink pattern changes during recording
  - [ ] Optional: LED flash pattern indicates time remaining
  - [ ] Maintain existing LED functionality as fallback
- [ ] Implement error handling (AC: 6)
  - [ ] Timer creation failure handling
  - [ ] Timer callback error handling
  - [ ] Automatic state recovery if timer fails
- [ ] Validate file duration accuracy (AC: 7)
  - [ ] Verify WAV file size matches 10 seconds of audio
  - [ ] Test file duration with audio playback software
  - [ ] Confirm audio sample count matches expected duration

## Dev Notes

### Relevant Source Tree Information
Based on architecture analysis:
- **Primary Files**: `softwareV2/main/recorder.c` (timer implementation)
- **Integration Points**: State machine (Story 2.2), `softwareV2/main/ui.c` (LED feedback)
- **Dependencies**: FreeRTOS timer APIs, recording state management

### Critical Technical Details
From Technical Debt analysis - this resolves **DEBT_HIGH** item:
- No 10-second automatic stop implementation in current main.c
- Estimated 4 hours implementation (per technical debt registry)
- Essential for user experience - prevents accidentally long recordings

### Technical Implementation Details
- **Audio Duration Calculation**: 16kHz × 2 channels × 2 bytes/sample × 10 seconds = 640,000 bytes
- **WAV File Size**: ~320KB (including headers) for 10 seconds
- **Timer Precision**: Use FreeRTOS software timers with 1ms resolution
- **State Coordination**: Timer must coordinate with state machine from Story 2.2

### Integration Requirements
- **DEPENDS ON** Story 2.2 (Recording State Machine) - timer triggers state transitions
- **COORDINATES WITH** Story 2.4 (WAV Writing) - timer determines when to finalize file
- **PRESERVES** existing LED feedback patterns while adding countdown feature

### User Experience Requirements
From PRD analysis:
- Users expect hands-free operation after button press
- Consistent recording length enables predictable file sizes
- Visual feedback helps users understand recording progress

### Testing
**Test Standards from Architecture**:
- **Timer Accuracy Testing**: Verify 10-second duration within ±100ms tolerance
- **State Integration Testing**: Confirm timer properly triggers state transitions
- **Resource Management Testing**: Verify timer cleanup prevents memory leaks
- **Audio Duration Testing**: Validate actual recorded audio duration matches timer

**Specific Testing Requirements**:
- Test timer starts with button press and recording begins
- Test timer stops recording after exactly 10 seconds
- Test timer cancellation if manual stop implemented
- Test timer behavior during error conditions
- Verify WAV file contains exactly 10 seconds of audio
- Test LED countdown patterns (if implemented)
- Confirm no timer resource leaks over multiple recordings

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-22 | 1.0 | Initial story creation for Phase 2 Sprint | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled during development*

### Debug Log References
*To be filled during development*

### Completion Notes List
*To be filled during development*

### File List
*To be filled during development*

## QA Results
*Results from QA Agent review will be populated here after implementation*