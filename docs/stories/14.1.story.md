# Story 14.1 — R0: Button‑Controlled Single Recording to Internal Flash

Status: Draft

## Story Statement

From power‑on, a short press on SW2 starts recording to a single WAV file stored in internal flash and turns LED on; a subsequent short press stops recording, finalizes the WAV header, stores the file, and turns LED off.

## Acceptance Criteria

1. Short press on SW2 starts recording; LED turns on within 100 ms and remains on while recording.
2. A second short press stops recording; LED turns off within 100 ms; exactly one playable WAV exists in internal flash.
3. Debounce prevents unintended toggles: two presses <100 ms apart do not produce start+stop.
4. On unexpected reset during recording, device boots without crash; partial file does not corrupt filesystem.

## Dev Notes (sourced from architecture docs only)

- Use UI Controller for LED and button handling; SW2 mapped to IO4 [Source: architecture/interfaces]
- WAV Writer handles header finalization and fsync on stop [Source: architecture/firmware-components#WAV Writer]
- Storage Manager: for R0 use internal flash VFS; SD not required [Source: architecture/firmware-components#SD Storage Manager]
- App State Machine: minimal states Idle ↔ Recording; no sleep modes required for R0 [Source: architecture/state-machine]
- Fixed audio format (mono 16 kHz 16‑bit) [Source: architecture/configuration-model]

## Tasks / Subtasks

- Button & LED
  - Configure SW2 GPIO with debounce (software debounce 100 ms) [Source: architecture/interfaces]
  - Implement LED on/off control mapped to Recording state [Source: architecture/firmware-components#UI Controller]
- Filesystem (Internal Flash)
  - Initialize internal flash VFS path (e.g., `/flash`) [Source: architecture/firmware-components#SD Storage Manager]
  - Ensure single file path policy (e.g., `/flash/r0.wav`); delete/overwrite on new session
- Recording Control
  - Wire button ISR/task to start/stop commands
  - Start: open WAV with fixed format; begin writing frames
  - Stop: finalize header; close file; turn off LED
- Resilience
  - Ensure safe behavior if stop requested while not recording (no‑op)
  - On boot, if leftover partial file exists, do not crash; allow overwrite
- Verification
  - Log start/stop timestamps; confirm LED timing within 100 ms budget
  - Manual test: copy WAV and verify playback

## Project Structure Notes

- Place R0 internals under `software_v1/main/` modules already scaffolded; add minimal internal‑flash VFS helpers if needed [Source: architecture/unified-project-structure]
