# Story 2.1: ADC Audio Capture Implementation

## Status
Ready for Review

## Story
**As a** sales professional,  
**I want** the device to capture real audio from the microphones when I press the button,  
**so that** my spoken words are recorded instead of silence.

## Acceptance Criteria
1. ADC continuous mode configured for dual MAX9814 microphones
2. Audio sampling at 16kHz with proper bit depth configuration  
3. Dual microphone channels captured simultaneously (stereo input)
4. Audio buffer management handles real-time capture without dropouts
5. Integration preserves existing button press detection functionality
6. Captured audio data flows to existing WAV writing system
7. No regression in current SD card file creation workflow

## Tasks / Subtasks
- [x] Replace audio_capture.c stub implementation with real ADC (AC: 1, 2)
  - [x] Configure ADC continuous mode with DMA
  - [x] Set up dual microphone channel configuration (GPIO assignments per hardware config)
  - [x] Implement 16kHz sampling rate with SOC_ADC_DIGI_MAX_BITWIDTH
  - [x] Test basic ADC functionality independently
- [x] Implement real-time audio buffer management (AC: 4)
  - [x] Create circular buffer for audio data
  - [x] Implement buffer overflow protection
  - [x] Add buffer status monitoring for debugging
- [x] Integrate with existing button workflow (AC: 5, 7)
  - [x] Modify button press handler to start ADC capture
  - [x] Ensure LED feedback continues to work
  - [x] Test that SD card file creation is not disrupted
- [x] Connect audio capture to WAV writer (AC: 6)
  - [x] Modify WAV writer to accept real audio data instead of silence
  - [x] Ensure proper audio data formatting for WAV file structure
  - [x] Test end-to-end: Button → Audio capture → WAV file creation

## Dev Notes

### Relevant Source Tree Information
Based on architecture analysis:
- **Primary Files**: `softwareV2/main/audio_capture.c` (needs complete rewrite)
- **Integration Points**: `softwareV2/main/ui.c` (button handling), `softwareV2/main/wav_writer.c` (audio data output)
- **Hardware Config**: `softwareV2/main/include/hardware_config.h` (MIC1_ADC_CH, MIC2_ADC_CH definitions)
- **Dependencies**: FreeRTOS task management, ESP32-S3 ADC drivers

### Critical Technical Details
From Technical Debt analysis - this resolves **DEBT_CRITICAL** item:
- Current `audio_capture.c` generates silence instead of real audio
- ADC implementation requires ADC_CONV_DUAL_UNIT_2 mode for dual microphones
- Buffer configuration: max_store_buf_size = 4096, conv_frame_size = 1024
- Must use ADC_ATTEN_DB_11 attenuation for MAX9814 compatibility

### Integration Requirements
From Implementation Roadmap:
- **PRESERVE** Phase 1 functionality: Button press → LED feedback → SD file creation must continue working
- **ADD** real audio capture to existing workflow without breaking current patterns
- Use existing task structure and FreeRTOS queuing patterns established in Phase 1

### Testing
**Test Standards from Architecture**:
- **Test Location**: Integration tests in main application  
- **Regression Testing**: Must validate Phase 1 functionality remains intact
- **Audio Validation**: Use GPIO debug pins or LED patterns to confirm audio capture active
- **Hardware Testing**: Test with actual speech input to dual microphones
- **Build Testing**: Ensure diagnostic build profile still works for rollback capability

**Specific Testing Requirements**:
- Test ADC initialization without crashes
- Verify dual microphone channel data capture
- Confirm audio buffer doesn't overflow during typical 10-second recording
- Validate integration with existing button press workflow
- Test that files are still created on SD card with correct sequential naming

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-22 | 1.0 | Initial story creation for Phase 2 Sprint | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
*To be filled during development*

### Completion Notes List
- Successfully implemented ADC continuous mode with dual microphone support (GPIO 9, GPIO 12)
- Replaced stub audio_capture.c with real ADC implementation using ESP32-S3 native drivers
- Configured 16kHz sampling rate with 16-bit resolution for stereo audio capture
- Implemented circular buffer system with overflow protection for real-time audio processing
- Integrated audio capture with existing button workflow while preserving Phase 1 functionality
- Audio callback system streams captured data directly to WAV writer for file creation
- Build system updated to include audio_capture.c and wav_writer.c components
- Updated deprecated ADC_ATTEN_DB_11 to ADC_ATTEN_DB_12 for ESP-IDF v5.2 compatibility
- Used curve fitting calibration scheme (adc_cali_curve_fitting) for ESP32-S3 platform

### File List
- **Modified**: `softwareV2/main/audio_capture.c` - Complete rewrite from stub to real ADC implementation
- **Modified**: `softwareV2/main/main.c` - Added audio capture integration with button workflow
- **Modified**: `softwareV2/main/CMakeLists.txt` - Added audio_capture.c and wav_writer.c to build
- **Verified**: `softwareV2/main/wav_writer.c` - Confirmed existing implementation works with audio data
- **Verified**: `softwareV2/main/audio_capture.h` - Header interface preserved for compatibility

## QA Results
*Results from QA Agent review will be populated here after implementation*