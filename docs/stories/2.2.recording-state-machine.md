# Story 2.2: Recording State Machine Integration

## Status
Approved

## Story
**As a** sales professional,  
**I want** the device to properly manage recording states when I press the button,  
**so that** recording starts, runs, and stops in a controlled manner.

## Acceptance Criteria
1. Recording state machine replaces simple main.c GPIO test
2. Button press transitions device from IDLE to RECORDING state
3. Recording state manages audio capture start/stop workflow
4. State machine integrates with existing LED feedback system
5. RECORDING state coordinates audio capture with file writing
6. Error states handle failures gracefully and return to IDLE
7. State transitions preserve existing button debouncing behavior

## Tasks / Subtasks
- [ ] Implement recording state machine architecture (AC: 1, 2)
  - [ ] Define recording_state_t enum (IDLE, RECORDING, STOPPING, ERROR)
  - [ ] Create state transition functions
  - [ ] Implement state change event handling
  - [ ] Add state machine debug logging
- [ ] Integrate state machine with main.c (AC: 1)
  - [ ] Replace simple GPIO test loop with state machine
  - [ ] Maintain compatibility with existing initialization
  - [ ] Ensure build system compatibility
- [ ] Connect state machine to button handling (AC: 2, 7)
  - [ ] Modify ui.c button press handler to trigger state transitions
  - [ ] Preserve existing button debouncing logic
  - [ ] Add protection against multiple rapid button presses
- [ ] Coordinate recording workflow (AC: 3, 5)
  - [ ] IDLE → RECORDING: Start audio capture and file creation
  - [ ] RECORDING → STOPPING: Graceful recording termination
  - [ ] STOPPING → IDLE: Complete file writing and cleanup
- [ ] Integrate LED feedback with states (AC: 4)
  - [ ] IDLE state: LED off or slow blink
  - [ ] RECORDING state: LED on or fast blink
  - [ ] ERROR state: LED error pattern
- [ ] Implement error handling (AC: 6)
  - [ ] Audio capture failure handling
  - [ ] SD card write failure handling
  - [ ] Memory allocation failure handling
  - [ ] Automatic recovery to IDLE state

## Dev Notes

### Relevant Source Tree Information
Based on architecture analysis:
- **Primary Files**: `softwareV2/main/main.c` (needs replacement), `softwareV2/main/recorder.c` (needs implementation)
- **Integration Points**: `softwareV2/main/ui.c` (button handling), `softwareV2/main/audio_capture.c` (start/stop control)
- **Data Models**: `softwareV2/main/include/data_models.h` (recording_state_t definition)

### Critical Technical Details
From Technical Debt analysis - this resolves **DEBT_CRITICAL** item:
- Current main.c is simple GPIO test, needs full recorder integration
- State machine must coordinate multiple services: audio capture, file writing, UI feedback
- Estimated 8 hours implementation (per technical debt registry)

### State Machine Architecture
From High Level Architecture analysis:
```c
typedef enum {
    RECORDING_STATE_IDLE = 0,
    RECORDING_STATE_RECORDING,
    RECORDING_STATE_STOPPING,
    RECORDING_STATE_ERROR
} recording_state_t;
```

### Integration Requirements
- **PRESERVE** existing button debouncing and LED feedback patterns from Phase 1
- **COORDINATE** with audio_capture.c (Story 2.1) for recording start/stop
- **INTEGRATE** with existing SD card workflow without breaking file creation
- Use FreeRTOS event groups for state synchronization between components

### Testing
**Test Standards from Architecture**:
- **State Transition Testing**: Verify all valid state transitions work correctly
- **Error State Testing**: Test error conditions and recovery paths
- **Integration Testing**: Confirm state machine doesn't break existing button + LED + SD workflow
- **Timing Testing**: Verify state transitions happen within expected timeframes

**Specific Testing Requirements**:
- Test button press starts recording (IDLE → RECORDING)
- Test graceful recording stop (RECORDING → STOPPING → IDLE)
- Test error conditions (audio capture failure, SD card failure)
- Test rapid button press protection (debouncing)
- Verify LED patterns match recording states
- Confirm existing file creation and naming still works

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-22 | 1.0 | Initial story creation for Phase 2 Sprint | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled during development*

### Debug Log References
*To be filled during development*

### Completion Notes List
*To be filled during development*

### File List
*To be filled during development*

## QA Results
*Results from QA Agent review will be populated here after implementation*