# Story 1.1 — Audio VOX MVP

Status: Draft

## Story Statement

Implement voice-activated recording (VOX) minimal viable feature. When input level exceeds a configurable threshold for a sustained duration, start recording; stop after configurable silence duration. Persist audio as WAV to SD per PRD conventions.

## Acceptance Criteria

1. When `vox.enabled=true`, sustained level over `vox.start_threshold_dbfs` for `vox.start_hold_ms` begins recording and includes `vox.pre_roll_ms` audio.
2. Sustained level under `vox.stop_threshold_dbfs` for `vox.stop_hold_ms` stops recording and includes `vox.post_roll_ms` audio.
3. No recordings start when free space < configured minimum; an error state is indicated via LED and logs capture the reason.
4. LED patterns reflect VOX armed vs recording vs error states.
5. Manual button start/stop overrides VOX; VOX re‑arms after manual stop.

## Dev Notes (sourced from architecture docs only)

- Audio pipeline components to use:
  - Audio Capture Service (ADC/I2S with double‑buffered DMA) [Source: architecture/firmware-components#Audio Capture Service]
  - WAV Writer (ring buffer consumer; fsync on split/stop) [Source: architecture/firmware-components#WAV Writer]
  - SD Storage Manager (mount/re‑mount, free‑space checks, pruning policy) [Source: architecture/firmware-components#SD Storage Manager]
  - UI Controller (LED patterns, button debouncing/gestures) [Source: architecture/firmware-components#UI Controller]
  - Power Manager (Idle/Record/Light/Deep transitions) [Source: architecture/firmware-components#Power Manager]
- Data flow: Button/VOX → App State Machine → Capture → PCM buffers → WAV Writer → FATFS (SD) [Source: architecture/data-flow]
- State machine anchors to extend with VOX sub‑states (Armed → Pre‑Roll → Recording → Post‑Roll) [Source: architecture/state-machine]
- Storage layout and filenames: `/records/YYYY/MM/DD/` with `YYYYMMDD_HHMMSS_{NN}.wav` [Source: architecture/storage-layout]
- Power: Prefer idle/light sleep when armed; wake on GPIO timer; keep BLE/Wi‑Fi off unless provisioning [Source: architecture/power-modes]
- Interfaces: Button SW2 (start/stop, long‑press provisioning); LED status patterns per UI Controller [Source: architecture/interfaces]

Note: The architecture documents do not prescribe VOX threshold values; thresholds are configuration, persisted in NVS and optional `/config.json` [Source: architecture/configuration-model].

## Tasks / Subtasks

- Configuration
  - Add VOX keys to config model and NVS I/O (`vox.enabled`, `vox.start_threshold_dbfs`, `vox.start_hold_ms`, `vox.stop_threshold_dbfs`, `vox.stop_hold_ms`, `vox.pre_roll_ms`, `vox.post_roll_ms`) [Source: architecture/configuration-model]
  - Expose sane defaults in code; load override from `/config.json` if present [Source: architecture/configuration-model]
- Audio metering and VOX state
  - Implement rolling RMS/peak meter on capture buffer; compute dBFS per window [Source: architecture/firmware-components#Audio Capture Service]
  - Implement VOX sub‑state machine: Armed → Pre‑Roll → Recording → Post‑Roll (hysteresis and hold timers) [Source: architecture/state-machine]
  - Integrate pre/post roll buffers with ring buffer feeding WAV Writer [Source: architecture/firmware-components#WAV Writer]
- Storage
  - Guard start with min free space check; log and LED error if below threshold [Source: architecture/firmware-components#SD Storage Manager]
  - Ensure WAV header validity on stop and split; fsync on stop/split [Source: architecture/error-handling-resilience]
- UI
  - LED patterns: idle/armed, recording, error/low‑space [Source: architecture/firmware-components#UI Controller]
  - Button SW2 overrides VOX during manual session; VOX re‑arms after stop [Source: architecture/interfaces]
- Power
  - When armed but idle, prefer light sleep with periodic metering or low‑duty sampling [Source: architecture/power-modes]

## Project Structure Notes

- Firmware lives under `software_v1/` per current repo. Align module placement with architecture components:
  - `software_v1/main/` for app entry and thin orchestration
  - Separate modules for capture, WAV writer, storage, UI, config [Source: architecture/unified-project-structure]

## File Locations (planned)

- `software_v1/main/vox_config.[ch]` — VOX configuration load/save [Source: architecture/configuration-model]
- `software_v1/main/vox_state.[ch]` — VOX state machine and timers [Source: architecture/state-machine]
- `software_v1/main/audio_capture.[ch]` — Capture DMA & metering hooks [Source: architecture/firmware-components#Audio Capture Service]
- `software_v1/main/wav_writer.[ch]` — WAV writer integration [Source: architecture/firmware-components#WAV Writer]
- `software_v1/main/sdcard.[ch]` — SD mount and free‑space checks [Source: architecture/firmware-components#SD Storage Manager]
- `software_v1/main/ui.[ch]` — LED/button handling [Source: architecture/firmware-components#UI Controller]
