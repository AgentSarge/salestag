# Story 2.4: Real Audio Data WAV Writing

## Status
Approved

## Story
**As a** sales professional,  
**I want** the WAV files to contain my actual recorded speech instead of silence,  
**so that** I can play back and listen to my sales interactions.

## Acceptance Criteria
1. WAV files contain real audio data from ADC capture instead of silence
2. Audio data properly formatted for 16kHz stereo WAV file structure
3. File size matches expected duration (~320KB for 10 seconds)
4. Audio quality sufficient for speech recognition (clear, minimal noise)
5. WAV file headers correctly specify audio format and duration
6. Files remain compatible with standard audio playback software
7. No audio dropouts or corruption in recorded files

## Tasks / Subtasks
- [ ] Modify WAV writer to accept real audio data (AC: 1, 2)
  - [ ] Replace silence generation with audio buffer input
  - [ ] Ensure proper audio data formatting for WAV structure
  - [ ] Handle stereo channel interleaving correctly
  - [ ] Test WAV file header generation with real audio metadata
- [ ] Implement audio data streaming to file (AC: 3, 7)
  - [ ] Stream audio buffers from ADC to SD card efficiently
  - [ ] Implement buffer management to prevent dropouts
  - [ ] Add audio data validation during write process
  - [ ] Monitor file size during recording to verify expected growth
- [ ] Optimize audio quality parameters (AC: 4)
  - [ ] Configure proper gain levels for MAX9814 microphones
  - [ ] Implement basic noise filtering if needed
  - [ ] Test audio clarity with actual speech input
  - [ ] Verify stereo channel balance and quality
- [ ] Validate WAV file format compliance (AC: 5, 6)
  - [ ] Verify WAV headers contain correct audio format specifications
  - [ ] Test file compatibility with VLC, Windows Media Player, QuickTime
  - [ ] Validate file duration metadata matches actual content
  - [ ] Ensure proper file termination and header finalization
- [ ] Implement comprehensive audio testing (AC: 7)
  - [ ] Test continuous recording without audio gaps
  - [ ] Verify audio synchronization between channels
  - [ ] Test file integrity after recording completion
  - [ ] Validate audio quality meets speech recognition requirements

## Dev Notes

### Relevant Source Tree Information
Based on architecture analysis:
- **Primary Files**: `softwareV2/main/wav_writer.c` (needs modification for real audio)
- **Integration Points**: `softwareV2/main/audio_capture.c` (audio data source), `softwareV2/main/sd_storage.c` (file writing)
- **Data Models**: WAV file format structures, audio buffer management

### Critical Technical Details
From architecture analysis:
- Current `wav_writer.c` generates WAV headers but writes silence instead of audio
- Must integrate with ADC capture from Story 2.1 to receive real audio data
- WAV format: 16kHz, 16-bit, stereo (2 channels) = 64KB/second data rate

### Audio Format Specifications
- **Sample Rate**: 16kHz (16,000 samples per second)
- **Bit Depth**: 16-bit (2 bytes per sample)
- **Channels**: 2 (stereo - left/right microphones)
- **Data Rate**: 16kHz × 2 channels × 2 bytes = 64KB/second
- **10-Second File**: ~640KB audio data + WAV headers = ~320KB total

### Integration Requirements
- **DEPENDS ON** Story 2.1 (ADC Audio Capture) - receives audio data from ADC buffers
- **COORDINATES WITH** Story 2.3 (Recording Timer) - timer determines when to finalize WAV file
- **BUILDS ON** existing SD card file creation workflow from Phase 1
- **PRESERVES** sequential file naming (recording_001.wav, etc.)

### Audio Quality Requirements
From PRD analysis:
- Audio must be suitable for sales interaction review
- Speech clarity is primary requirement (not music quality)
- Background noise suppression beneficial but not critical for MVP
- Dual microphone setup enables potential noise cancellation in future

### Testing
**Test Standards from Architecture**:
- **Audio Quality Testing**: Record actual speech and verify playback clarity
- **File Format Testing**: Validate WAV compliance with standard audio tools
- **Performance Testing**: Verify real-time recording without dropouts
- **Integration Testing**: Confirm complete workflow from button to playable file

**Specific Testing Requirements**:
- Record test speech and play back in multiple audio applications
- Verify file size matches expected duration (320KB for 10 seconds)
- Test stereo channel separation and balance
- Confirm WAV file headers contain correct metadata
- Test continuous recording without audio gaps or corruption
- Verify files open correctly in VLC, Windows Media Player, etc.
- Test recording quality at different speaking volumes and distances

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-22 | 1.0 | Initial story creation for Phase 2 Sprint | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled during development*

### Debug Log References
*To be filled during development*

### Completion Notes List
*To be filled during development*

### File List
*To be filled during development*

## QA Results
*Results from QA Agent review will be populated here after implementation*